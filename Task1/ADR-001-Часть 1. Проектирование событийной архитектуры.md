# ADR-001: Часть 1. Проектирование событийной архитектуры
## Автор: Сурков Александр
## Дата: 28.08.2025
## 1. Контекст
Компания **NovaMarket** — стартап в сфере e-commerce. Она хочет запустить онлайн-маркетплейс с нуля, где продавцы размещают товары, а покупатели заказывают их с доставкой.

### Цели бизнеса
#### Промежуточное состояние (через пару месяцев)
- Запуск MVP с базовыми функциями: 
  - каталог
  - оформление заказа
  - оплата
  - уведомления
  - просмотр истории заказа
- В качестве клиентского канала сначала будет только мобильное приложение.
- Обработка до 2500 заказов в день.
- Возможность подключить нового продавца без изменения архитектуры.
- Первые интеграции с внешними сервисами (платежный шлюз, служба доставки).
#### Финальное состояние (через год)
- Масштабирование до 40 000+ заказов в день.
- Расширение функционала: 
  - промо-акции
  - возвраты
  - программа лояльности
  - аналитика
- Появление других клиентских каналов: 
  - сайт
  - чат-бот
  - встройка возможностей заказа в умных ассистентов
- Возможность легко подключать новые сервисы по подписке на события (например, рекомендации, аналитика, антифрод).
- Подготовка к выходу на новые рынки (мультирегиональность).

Общее требование ко всем интерфейсам пользователя заключается в том, что отклик должен быть минимальным и не превышать 1 секунды в 99,99%. При этом ожидаемый показатель в 98% равен 0,3 сек.

## 2. Требования
### 2.1 Функциональные требования
#### 2.1.1 Выбор товара
Покупатель заходит на платформу и видит каталог товаров. Он может:
- Просматривать список доступных товаров с актуальными:
  - ценами
  - названием
  - фотографиями
  - кратким описанием
- Фильтровать товары по:
  - категориям
  - цене
  - **рейтингу**
- Открыть подробную карточку товара
- Ознакомиться с **отзывами** других покупателей
- Если покупатель заинтересован, он добавляет товар в **корзину**, но пока не оформляет заказ.
С точки зрения бизнеса важно, чтобы информация о товарах была точной и актуальной – особенно наличие и цена. 
Покупатель принимает решение о покупке на основе этих данных, поэтому любые несоответствия (например, товар есть в каталоге, но отсутствует на складе) снижают доверие.

#### 2.1.2 Оформление заказа
Когда покупатель решил купить выбранные товары, он открывает корзину и начинает оформление.
- Шаг 1. Подтверждение состава заказа
  - Покупатель проверяет список товаров, их количество, цену и итоговую сумму.
  - Указывает адрес **доставки** и выбирает способ получения:
    - курьер
    - самовывоз
    - пункт выдачи
  - Выбирает способ оплаты.
- Шаг 2. Проверка и резервирование товаров
  - После подтверждения заказа система проверяет, доступны ли товары в нужном количестве.
  - Если всё в наличии, товар резервируется на **складе**, чтобы его не купил кто-то другой.
- Шаг 3. Оплата
  - Покупатель перенаправляется на платёжную страницу, где вводит данные карты или выбирает другой способ оплаты.
  - Также покупатель может привязать карту, и тогда все последующие оплаты должны осуществляться автоматически
  - Деньги либо успешно списываются, либо операция отклоняется (например, из-за недостатка средств).
  - Если платёж успешен, заказ переходит в следующий этап. Если нет, он отменяется.
- Шаг 4. Подготовка к доставке
  - После успешной оплаты формируется заявка на доставку, где указывается адрес, получатель и список товаров.
  - Заявка отправляется в **логистическую службу** (внутреннюю или внешнюю).
  - Продавец получает уведомление, что нужно подготовить товар к отправке.

Для бизнеса важно, чтобы оформление заказа было быстрым, удобным и прозрачным для покупателя. При этом нужно гарантировать, что заказ будет выполнен: если покупатель оплатил товар, он должен быть зарезервирован и доставлен.

#### 2.1.3 Отслеживание статуса заказа
После оформления и оплаты покупатель хочет знать, что происходит с его заказом.
- В личном кабинете он видит заказ со статусом, который меняется по мере обработки: 
  - Ожидает оплаты
  - Оплачен
  - готовится к отправке
  - Передан в доставку
  - Доставлен
- Покупатель может открыть заказ и увидеть подробности: 
  - состав
  - сумму 
  - адрес доставки
  - выбранный способ доставки
  - предполагаемую дату получения
- Если заказ передан в логистическую компанию, покупатель видит трек-номер и может следить за доставкой.  
  Продавец тоже должен видеть статус заказов, чтобы понимать, что уже отправлено, а что ещё нужно обработать.  
  С точки зрения бизнеса это важно, чтобы покупатель чувствовал контроль и уверенность, а не звонил в поддержку с вопросом «где мой заказ?». Чем прозрачнее процесс, тем выше доверие к платформе.

### 2.2 Нефункциональные требования
На первом этапе(MVP)
- необходимо выдерживать нагрузку по обработке до 2500 заказов в день
- во всех интерфейсах(пока мобильное приложение) пользователя отклик должен быть минимальным и не превышать 1 секунды в 99,99%. При этом ожидаемый показатель в 98% равен 0,3 сек.
- возможность подключить нового продавца без изменения архитектуры

На втором этапе(через год)
- масштабирование до 40 000+ заказов в день
- расширение функционала: промо-акции, возвраты, программа лояльности, аналитика
- появление других клиентских каналов: сайт, чат-бот, встройка возможностей заказа в умных ассистентов
- возможность легко подключать новые сервисы по подписке на события (например, рекомендации, аналитика, антифрод)
- подготовка к выходу на новые рынки (мультирегиональность)

## 3. Решение
### 3.1 Диаграмма контейнера в модели C4. Вариант 1.
```plantuml
@startuml MSA-3-NovaMarket

!define C4P https://raw.githubusercontent.com/SurkovAleksandr/MSA-AgroTech-sprint-1/refs/heads/master
!includeurl C4P/c4_model/C4_Container.puml

SHOW_PERSON_OUTLINE() 

title Диаграмма контейнеров C4 системы NovaMarket

' Контекст системы
Person(buyer, "Покупатель", "Покупает товары")
Person(seller, "Продавец", "Размещает товары")

System_Boundary(novaMarket, "NovaMarket Marketplace") {
  
  Container(buyerMobileApp, "Мобильное приложение покупателя", "iOS/Android", "Клиентское приложение для покупателей")
  Container(sellerMobileApp, "Мобильное приложение продавца", "iOS/Android", "Клиентское приложение для продавцов")

  Container(catalogService, "Каталог товаров", "Java", "Управление каталогом товаров, данных о наличии и ценах")
  Container(shoppingCatService, "Корзина товаров", "Java", "Товары, которые покупатель добавил в корзину")
  Container(reviewService, "Оценки, отзывы о товарах", "Java", "Отзывы покупателей о товарах")
  Container(orderService, "Заказы", "Java", "Обработка заказа: приём, проверка доступности, резервирование товаров")
  Container(paymentService, "Оплата", "Java", "Обработка платежей и взаимодействие с платежным шлюзом")
  Container(notificationService, "Уведомления", "Java", "Отправка уведомлений продавцам и покупателям")
  Container(deliveryService, "Доставка", "Java", "Компоновка заказа и отправка в логистическую службу")

  ContainerQueue(eventBus, "Event Bus", "Kafka", "Шина событий")

  ContainerDb(catalogDb, "Товары", "PostgreSQL", "Хранение данных о товарах")
  ContainerDb(orderDb, "Order DB", "PostgreSQL", "Хранение заказов и их статусов")
  ContainerDb(paymentDb, "Payment DB", "PostgreSQL", "Данные по платежам")
  ContainerDb(notificationDb, "Notification DB", "PostgreSQL", "Управление очередью уведомлений")
  ContainerDb(deliveryDb, "Delivery DB", "PostgreSQL", "Данные о доставках и заявках")

}

' Внешние системы
System_Ext(paymentGateway, "Платежный шлюз", "Внешний сервис для обработки платежей")
System_Ext(logisticsProvider, "Логистический провайдер", "Сторонний сервис для доставки товаров")
System_Ext(notificationGateway, "Шлюз уведомлений", "Внешний сервис для отправки уведомлений")
System_Ext(catalogMetaDb, "Картинки, видео товаров", "Облачное хранение", "Хранение изображений и видео товарах")


' Взаимодействия пользователей с системой
Rel(seller, sellerMobileApp, "Управление каталогом товаров")
Rel(buyer, buyerMobileApp, "Поиск и покупка товаров")


' Взаимодействия между контейнерами
Rel(sellerMobileApp, catalogService, "REST API", "Размещение товаров")
Rel(sellerMobileApp, reviewService, "REST API", "Получение отзывов о товарах")

Rel(buyerMobileApp, catalogService, "REST API", "Поиск и фильтрация товаров")
Rel(buyerMobileApp, reviewService, "REST API", "Получение отзывов о товарах")
Rel(buyerMobileApp, shoppingCatService, "REST API", "Корзина товаров пользователя")
Rel(buyerMobileApp, orderService, "REST API", "Оформление и управление заказами")
Rel(orderService, catalogService, "JSON-RPC/gRPC", "Проверка доступности товаров и резервирование")

Rel(buyerMobileApp, paymentService, "REST API", "Оплата заказа")
Rel(paymentService, paymentGateway, "Оплата товаров", "Оплата заказа через платёжный шлюз")

Rel_Up(notificationService, notificationGateway, "Уведомления о событиях", "Отправка email/SMS/Push уведомлений")
Rel(deliveryService, logisticsProvider, "Доставка товаров", "Передача товаров в доставку")

' Взаимодействие с базами данных
Rel(catalogService, catalogDb, "Информация о товарах")
Rel(sellerMobileApp, catalogMetaDb, "REST API", "Получение изображений и видео товарах")
Rel(catalogService, catalogMetaDb, "REST API", "Размещение изображений и видео товарах")
Rel(buyerMobileApp, catalogMetaDb, "REST API", "Получение изображений и видео товарах")
Rel(orderService, orderDb, "Информация о заказах")
Rel(paymentService, paymentDb, "Информация о платежах")

Rel(notificationService, notificationDb, "Уведомления")
Rel(deliveryService, deliveryDb, "Информация о доставках")

' Взаимодействие сервисов через события
Rel(orderService, eventBus, "Публикует событие о заказе", "")
Rel(eventBus, orderService, "Получение событий об облате и доставке заказа", "")
Rel(paymentService, eventBus, "Публикует события по оплате", "")
Rel(eventBus, deliveryService, "Получение событий о создании заказа", "")
Rel(deliveryService, eventBus, "Публикует статус доставки", "")
Rel(eventBus, notificationService, "Получение уведомлений", "Получение событий о заказах, оплате и доставки")


@enduml
```

## 4. Альтернативы

## 5. Недостатки, ограничения, риски
