# ADR-002: Часть 2. Проектирование Saga для оформления заказа
## Автор: Сурков Александр
## Дата: 28.08.2025
## 1. Контекст
Необходимо подробнее проработать реализацию сценария оформления заказа. В рамках этого сценария на разных этапах могут случиться ошибки вроде неоплаты заказа. Эти ошибки требуют компенсационных действий, поэтому здесь нужно спроектировать и реализовать Saga-хореографию.
Составьте реестр событий для вашей Saga-хореографии оформления заказа. Для каждого события опишите логический этап, тип этого события и наименование.

События могут быть одного из четырёх типов:
- Domain Events (доменные события)
- Failure Events (события ошибок)
- Compensation Events (компенсационные события)
- Timeout/Control Events (события таймаутов)

## 3. Решение
### 3.1 Таблица событий при оформлении заказа

| Этап                                                          | Тип события  | Название                     |
|---------------------------------------------------------------|--------------|------------------------------|
| Заказ инициирован(ожидает проверки наличия товаров)           | Domain       | OrderInitiated_D             |
| Заказ создан                                                  | Domain       | OrderCreated_D               |
| Заказ не создан                                               | Failure      | OrderNotCreated_F            |
| Заказ формируется                                             | Domain       | OrderStartedFormed_D         |
| Заказ не может быть сформирован(товар отсутствует у продавца) | Failure      | OrderCouldNotFormed_F        |
| Заказ сформирован                                             | Domain       | OrderIsFormed_D              |
| Заказ оплачен                                                 | Domain       | OrderPaid_D                  |
| Заказ не оплачен(ошибка при оплате)                           | Failure      | OrderErrorDuringPayment_F    |
| Заказ не оплачен(время ожидания оплаты истекло)               | Timeout      | OrderPaymentTimeExpired_T    |
| Заказ передан в службу доставки                               | Domain       | OrderTransferredToDelivery_D |
| Заказ в пути                                                  | Domain       | OrderOnWay_D                 |
| Заказ доставлен                                               | Domain       | OrderDelivered_D             |
| Заказ закрыт                                                  | Domain       | OrderClosed_D                |
| Заказ отменен пользователем(инициализация)                    | Domain       | OrderInitCancelled_D         |
| Заказ отменен пользователем(завершение)                       | Domain       | OrderFinishCancelled_D       |
| Заказ: пользователь получил возврат средств                   | Compensation | Order_UserReceivedRefund_C   |
| Заказ расформирован                                           | Compensation | OrderDisbanded_C             |


```plantuml
@startuml
autonumber

participant Покупатель
participant OrderService
participant PaymentService
participant DeliveryService

alt Сценарий: успешное создание и обработки заказа
    == Создание заказа ==
    Покупатель -> OrderService: Создать заказ 
    OrderService -> OrderService: Проверка наличия товара (OrderInitiated_D)
    OrderService -> DeliveryService: Заказ создан (OrderCreated_D)

    == Формирование заказа ==
    DeliveryService -> OrderService: Заказ формируется (OrderStartedFormed_D)
    DeliveryService -> OrderService: Заказ сформирован  (OrderIsFormed_D)

    == Оплата заказа ==
    Покупатель -> PaymentService: Оплата заказа
    PaymentService -> OrderService: Заказ оплачен (OrderPaid_D)
    PaymentService -> DeliveryService: Заказ оплачен (OrderPaid_D)

    == Доставка заказа ==
    DeliveryService -> OrderService: Заказ передан в службу доставки (OrderTransferredToDelivery_D)
    DeliveryService -> OrderService: Заказ в пути (OrderOnWay_D)
    DeliveryService -> OrderService: Заказ доставлен (OrderDelivered_D)

    == Закрытие заказа ==
    OrderService -> DeliveryService: Закрыть заказ (OrderClosed_D)
    OrderService -> PaymentService: Закрыть заказ (OrderClosed_D)
end


alt Сценарий: отмена заказа Покупателем после оплаты 
    == Создание заказа ==
    Покупатель -> OrderService: Создать заказ 
    OrderService -> OrderService: Проверка наличия товара (OrderInitiated_D)
    OrderService -> DeliveryService: Заказ создан (OrderCreated_D)

    == Формирование заказа ==
    DeliveryService -> OrderService: Заказ формируется (OrderStartedFormed_D)
    DeliveryService -> OrderService: Заказ сформирован (OrderIsFormed_D)

    == Оплата заказа ==
    Покупатель -> PaymentService: Оплата заказа
    PaymentService -> OrderService: Заказ оплачен (OrderPaid_D)
    PaymentService -> DeliveryService: Заказ оплачен (OrderPaid_D)

    == Отмена заказа ==
    Покупатель -> OrderService: Отмена заказа
    OrderService -> PaymentService++: Заказ отменен пользователем (OrderInitCancelled_D)
    OrderService -> DeliveryService++: Заказ отменен пользователем (OrderInitCancelled_D)

    == Компенсирующие действия ==
    PaymentService -> PaymentService: Возврат денег пользователю
    PaymentService --> OrderService--: Заказ: пользователь получил возврат средств (Order_UserReceivedRefund_C)
    DeliveryService -> DeliveryService: Отмена доставки
    DeliveryService --> OrderService--: Заказ расформирован (OrderDisbanded_C)

    == Отмена заказа ==
    OrderService -> OrderService: Заказ отменен пользователем(завершение) (OrderFinishCancelled_D)
    OrderService -> OrderService: Отмена заказа
end

@enduml

```

## 4. Альтернативы

## 5. Недостатки, ограничения, риски
